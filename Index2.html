<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Dashboard Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #667eea;
        }

        .hidden {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .user-info {
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chart-type-selector {
            padding: 6px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .controls-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }

        .control-group select, .control-group input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .demo-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            color: #666;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .controls-panel {
                flex-direction: column;
                align-items: stretch;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Excel Dashboard Creator</h1>
            <p>Beautiful dashboards from your Excel data</p>
        </div>

        <!-- Login/Register Section -->
        <div class="section" id="authSection">
            <div class="tabs">
                <button class="tab active" onclick="showTab('login')">Login</button>
                <button class="tab" onclick="showTab('register')">Register</button>
            </div>

            <div class="tab-content active" id="loginTab">
                <div class="auth-container">
                    <h2 style="margin-bottom: 20px; color: #333;">Login to Dashboard</h2>
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter your username">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn" onclick="login()">Login</button>
                    <div class="demo-info">
                        <strong>Demo Account:</strong><br>
                        Username: admin<br>
                        Password: admin123
                    </div>
                </div>
            </div>

            <div class="tab-content" id="registerTab">
                <div class="auth-container">
                    <h2 style="margin-bottom: 20px; color: #333;">Create New Account</h2>
                    <div class="form-group">
                        <label for="regUsername">Username</label>
                        <input type="text" id="regUsername" placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Password</label>
                        <input type="password" id="regPassword" placeholder="Choose a password">
                    </div>
                    <div class="form-group">
                        <label for="regConfirmPassword">Confirm Password</label>
                        <input type="password" id="regConfirmPassword" placeholder="Confirm your password">
                    </div>
                    <button class="btn" onclick="register()">Create Account</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="hidden" id="dashboardSection">
            <!-- Dashboard Header with User Info -->
            <div class="dashboard-header">
                <div class="user-info">
                    <span id="userInfo">Welcome, User!</span>
                </div>
                <div>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="section" id="uploadSection">
                <h2 style="margin-bottom: 20px; color: #333; text-align: center;">Upload Your Excel File</h2>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">📁</div>
                    <h3>Click to upload or drag & drop your Excel file</h3>
                    <p style="color: #666; margin-top: 10px;">Supports .xlsx, .xls files</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
                </div>
            </div>

            <!-- Dashboard Controls and Charts -->
            <div class="section hidden" id="chartsSection">
                <div class="controls-panel">
                    <div class="control-group">
                        <label>Data Sheet</label>
                        <select id="sheetSelector" onchange="changeSheet()">
                            <option value="">Select Sheet</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>X-Axis Column</label>
                        <select id="xAxisSelector" onchange="updateCharts()">
                            <option value="">Select Column</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Y-Axis Column</label>
                        <select id="yAxisSelector" onchange="updateCharts()">
                            <option value="">Select Column</option>
                        </select>
                    </div>
                    <button class="btn" onclick="addNewChart()">Add Chart</button>
                    <button class="btn btn-success" onclick="exportDashboard()">Export Dashboard</button>
                </div>

                <div class="stats-grid" id="statsGrid"></div>
                <div class="dashboard-grid" id="chartGrid"></div>
                <div class="data-table hidden" id="dataTable"></div>
                <button class="btn" onclick="toggleDataTable()" style="margin-top: 20px;">Toggle Data Table</button>
            </div>
        </div>
    </div>

    <script>
        let currentWorkbook = null;
        let currentData = [];
        let charts = [];
        let chartCounter = 0;
        let currentUser = null;

        // User management system
        let users = [
            { username: 'admin', password: 'admin123', created: new Date().toISOString() }
        ];

        // Load saved data from localStorage
        function loadSavedData() {
            const savedUsers = localStorage.getItem('dashboardUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
        }

        // Save data to localStorage
        function saveUsers() {
            localStorage.setItem('dashboardUsers', JSON.stringify(users));
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
        });

        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Authentication functions
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showNotification('Please enter both username and password', 'error');
                return;
            }

            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                document.getElementById('userInfo').textContent = `Welcome, ${user.username}!`;
                showNotification('Login successful!', 'success');
            } else {
                showNotification('Invalid username or password', 'error');
            }
        }

        function register() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (!username || !password || !confirmPassword) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }

            if (users.find(u => u.username === username)) {
                showNotification('Username already exists', 'error');
                return;
            }

            const newUser = {
                username,
                password,
                created: new Date().toISOString()
            };

            users.push(newUser);
            saveUsers();
            showNotification('Account created successfully! Please login.', 'success');
            showTab('login');
            
            // Clear form
            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regConfirmPassword').value = '';
        }

        function logout() {
            currentUser = null;
            resetDashboard();
            
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            
            // Clear login form
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            showNotification('Logged out successfully', 'success');
        }

        function resetDashboard() {
            currentWorkbook = null;
            currentData = [];
            charts.forEach(chart => chart && chart.destroy());
            charts = [];
            chartCounter = 0;
            document.getElementById('chartGrid').innerHTML = '';
            document.getElementById('statsGrid').innerHTML = '';
            document.getElementById('dataTable').innerHTML = '';
            document.getElementById('chartsSection').classList.add('hidden');
        }

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showNotification('Please upload a valid Excel file (.xlsx or .xls)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    currentWorkbook = XLSX.read(e.target.result, { type: 'binary' });
                    populateSheetSelector();
                    document.getElementById('chartsSection').classList.remove('hidden');
                    showNotification('Excel file loaded successfully!', 'success');
                } catch (error) {
                    showNotification('Error reading Excel file: ' + error.message, 'error');
                }
            };
            reader.readAsBinaryString(file);
        }

        function populateSheetSelector() {
            const sheetSelector = document.getElementById('sheetSelector');
            sheetSelector.innerHTML = '<option value="">Select Sheet</option>';
            
            currentWorkbook.SheetNames.forEach(sheetName => {
                const option = document.createElement('option');
                option.value = sheetName;
                option.textContent = sheetName;
                sheetSelector.appendChild(option);
            });

            // Auto-select first sheet
            if (currentWorkbook.SheetNames.length > 0) {
                sheetSelector.value = currentWorkbook.SheetNames[0];
                changeSheet();
            }
        }

        function changeSheet() {
            const selectedSheet = document.getElementById('sheetSelector').value;
            if (!selectedSheet || !currentWorkbook) return;

            const worksheet = currentWorkbook.Sheets[selectedSheet];
            currentData = XLSX.utils.sheet_to_json(worksheet);
            
            if (currentData.length === 0) {
                showNotification('Selected sheet is empty', 'warning');
                return;
            }

            populateColumnSelectors();
            generateStats();
            updateDataTable();
            createDefaultCharts();
        }

        function populateColumnSelectors() {
            const xAxisSelector = document.getElementById('xAxisSelector');
            const yAxisSelector = document.getElementById('yAxisSelector');
            
            xAxisSelector.innerHTML = '<option value="">Select Column</option>';
            yAxisSelector.innerHTML = '<option value="">Select Column</option>';

            if (currentData.length > 0) {
                const columns = Object.keys(currentData[0]);
                columns.forEach(column => {
                    const xOption = document.createElement('option');
                    xOption.value = column;
                    xOption.textContent = column;
                    xAxisSelector.appendChild(xOption);

                    const yOption = document.createElement('option');
                    yOption.value = column;
                    yOption.textContent = column;
                    yAxisSelector.appendChild(yOption);
                });

                // Auto-select first two columns
                if (columns.length >= 2) {
                    xAxisSelector.value = columns[0];
                    yAxisSelector.value = columns[1];
                }
            }
        }

        function generateStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            if (currentData.length === 0) return;

            // Total records
            addStatCard('Total Records', currentData.length);

            // Numeric columns statistics
            const columns = Object.keys(currentData[0]);
            let numericStatsAdded = 0;
            
            columns.forEach(column => {
                if (numericStatsAdded >= 3) return; // Limit to 3 numeric stats
                
                const values = currentData.map(row => row[column]).filter(val => !isNaN(val) && val !== '');
                if (values.length > 0) {
                    const numericValues = values.map(Number);
                    const sum = numericValues.reduce((a, b) => a + b, 0);
                    const avg = sum / numericValues.length;
                    
                    if (numericValues.length > 5) {
                        addStatCard(`Avg ${column}`, Math.round(avg * 100) / 100);
                        numericStatsAdded++;
                    }
                }
            });
        }

        function addStatCard(label, value) {
            const statsGrid = document.getElementById('statsGrid');
            const statCard = document.createElement('div');
            statCard.className = 'stat-card';
            statCard.innerHTML = `
                <div class="stat-value">${value}</div>
                <div class="stat-label">${label}</div>
            `;
            statsGrid.appendChild(statCard);
        }

        function createDefaultCharts() {
            // Clear existing charts
            charts.forEach(chart => chart && chart.destroy());
            charts = [];
            chartCounter = 0;
            document.getElementById('chartGrid').innerHTML = '';

            // Create 3 default charts
            createChart('bar', 'Bar Chart', '#667eea');
            createChart('line', 'Line Chart', '#764ba2');
            createChart('pie', 'Pie Chart', '#f093fb');
        }

        function createChart(type, title, color = '#667eea') {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <div class="chart-header">
                    <h3 class="chart-title" contenteditable="true" onblur="updateChartTitle(${chartCounter}, this.textContent)">${title}</h3>
                    <div class="chart-controls">
                        <select class="chart-type-selector" onchange="changeChartType(${chartCounter}, this.value)">
                            <option value="bar" ${type === 'bar' ? 'selected' : ''}>Bar Chart</option>
                            <option value="line" ${type === 'line' ? 'selected' : ''}>Line Chart</option>
                            <option value="pie" ${type === 'pie' ? 'selected' : ''}>Pie Chart</option>
                            <option value="doughnut" ${type === 'doughnut' ? 'selected' : ''}>Doughnut</option>
                        </select>
                        <input type="color" value="${color}" onchange="updateChartColor(${chartCounter}, this.value)" style="width: 30px; height: 30px; border: none; border-radius: 4px; cursor: pointer;">
                        <button onclick="removeChart(${chartCounter})" style="background: #ff4757; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">✕</button>
                    </div>
                </div>
                <canvas id="chart-${chartCounter}" width="400" height="200"></canvas>
            `;

            document.getElementById('chartGrid').appendChild(chartContainer);

            const ctx = document.getElementById(`chart-${chartCounter}`).getContext('2d');
            const chartData = prepareChartData(type, color);
            
            const chart = new Chart(ctx, {
                type: type,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: type === 'pie' || type === 'doughnut' ? {} : {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            charts[chartCounter] = chart;
            chartCounter++;
        }

        function prepareChartData(type, color = '#667eea') {
            const xAxis = document.getElementById('xAxisSelector').value;
            const yAxis = document.getElementById('yAxisSelector').value;

            if (!xAxis || !yAxis || currentData.length === 0) {
                return { labels: [], datasets: [] };
            }

            const labels = [...new Set(currentData.map(row => row[xAxis]))].slice(0, 10);
            const data = labels.map(label => {
                const matchingRows = currentData.filter(row => row[xAxis] === label);
                const values = matchingRows.map(row => parseFloat(row[yAxis]) || 0);
                return values.reduce((sum, val) => sum + val, 0) / values.length || 0;
            });

            const colors = generateColorPalette(color, labels.length);

            return {
                labels: labels,
                datasets: [{
                    label: yAxis,
                    data: data,
                    backgroundColor: type === 'pie' || type === 'doughnut' ? colors : color,
                    borderColor: type === 'pie' || type === 'doughnut' ? colors : color,
                    borderWidth: 2,
                    fill: false
                }]
            };
        }

        function generateColorPalette(baseColor, count) {
            const colors = [];
            const base = baseColor.replace('#', '');
            const r = parseInt(base.substr(0, 2), 16);
            const g = parseInt(base.substr(2, 2), 16);
            const b = parseInt(base.substr(4, 2), 16);

            for (let i = 0; i < count; i++) {
                const factor = 0.8 + (i * 0.4 / count);
                const newR = Math.min(255, Math.floor(r * factor));
                const newG = Math.min(255, Math.floor(g * factor));
                const newB = Math.min(255, Math.floor(b * factor));
                colors.push(`rgb(${newR}, ${newG}, ${newB})`);
            }
            return colors;
        }

        function updateChartTitle(chartIndex, newTitle) {
            showNotification('Chart title updated', 'success');
        }

        function updateChartColor(chartIndex, newColor) {
            const chart = charts[chartIndex];
            if (!chart) return;

            const chartData = prepareChartData(chart.config.type, newColor);
            chart.data = chartData;
            chart.update();
            showNotification('Chart color updated', 'success');
        }

        function changeChartType(chartIndex, newType) {
            const chart = charts[chartIndex];
            if (!chart) return;
            
            const currentColor = chart.data.datasets[0].backgroundColor;
            const baseColor = Array.isArray(currentColor) ? '#667eea' : currentColor;
            
            chart.destroy();
            const ctx = document.getElementById(`chart-${chartIndex}`).getContext('2d');
            const chartData = prepareChartData(newType, baseColor);
            
            charts[chartIndex] = new Chart(ctx, {
                type: newType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: newType === 'pie' || newType === 'doughnut' ? {} : {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function removeChart(chartIndex) {
            if (charts[chartIndex]) {
                charts[chartIndex].destroy();
                delete charts[chartIndex];
            }
            document.getElementById(`chart-${chartIndex}`).closest('.chart-container').remove();
            showNotification('Chart removed', 'success');
        }

        function addNewChart() {
            const xAxis = document.getElementById('xAxisSelector').value;
            const yAxis = document.getElementById('yAxisSelector').value;
            
            if (!xAxis || !yAxis) {
                showNotification('Please select both X and Y axis columns', 'warning');
                return;
            }
            
            createChart('bar', `Chart ${chartCounter + 1}`);
        }

        function updateCharts() {
            charts.forEach((chart, index) => {
                if (chart) {
                    const currentColor = chart.data.datasets[0].backgroundColor;
                    const baseColor = Array.isArray(currentColor) ? '#667eea' : currentColor;
                    const newData = prepareChartData(chart.config.type, baseColor);
                    chart.data = newData;
                    chart.update();
                }
            });
        }

        function updateDataTable() {
            const dataTable = document.getElementById('dataTable');
            if (currentData.length === 0) return;

            const columns = Object.keys(currentData[0]);
            let tableHTML = `
                <h3 style="margin-bottom: 15px; color: #333;">Data Preview</h3>
                <table>
                    <thead>
                        <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
            `;

            // Show first 100 rows
            currentData.slice(0, 100).forEach(row => {
                tableHTML += `<tr>${columns.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`;
            });

            tableHTML += '</tbody></table>';
            if (currentData.length > 100) {
                tableHTML += `<p style="margin-top: 10px; color: #666;">Showing first 100 rows of ${currentData.length} total records</p>`;
            }

            dataTable.innerHTML = tableHTML;
        }

        function toggleDataTable() {
            const dataTable = document.getElementById('dataTable');
            dataTable.classList.toggle('hidden');
        }

        function exportDashboard() {
            const dashboardData = {
                sheets: currentWorkbook.SheetNames,
                currentSheet: document.getElementById('sheetSelector').value,
                xAxis: document.getElementById('xAxisSelector').value,
                yAxis: document.getElementById('yAxisSelector').value,
                totalCharts: charts.filter(chart => chart).length,
                totalRecords: currentData.length,
                user: currentUser.username,
                exportTime: new Date().toISOString(),
                charts: charts.map((chart, index) => {
                    if (!chart) return null;
                    const container = document.getElementById(`chart-${index}`).closest('.chart-container');
                    const title = container.querySelector('.chart-title').textContent;
                    return {
                        title,
                        type: chart.config.type,
                        data: chart.data
                    };
                }).filter(chart => chart !== null)
            };

            const blob = new Blob([JSON.stringify(dashboardData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('Dashboard exported successfully!', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;

            const colors = {
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800',
                info: '#2196F3'
            };

            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>